# This GitHub action can publish assets for release when a tag is created.
# Currently its setup to run on any tag that matches the pattern "v*" (ie. v0.1.0).
#
# This uses an action (hashicorp/ghaction-import-gpg) that assumes you set your
# private key in the `GPG_PRIVATE_KEY` secret and passphrase in the `PASSPHRASE`
# secret. If you would rather own your own GPG handling, please fork this action
# or use an alternative one for key handling.
#
# You will need to pass the `--batch` flag to `gpg` in your signing step
# in `goreleaser` to indicate this is being used in a non-interactive mode.
#
name: release
on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      skip_release:
        description: 'Skip GoReleaser (only generate changelog)'
        required: false
        default: 'false'
        type: boolean
permissions:
  contents: write
jobs:
  goreleaser:
    if: github.event_name == 'push' || github.event.inputs.skip_release != 'true'
    runs-on: ubuntu-latest
    steps:
      -
        name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
      -
        name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: 'go.mod'
          go-version: '1.24'
          cache: false
      -
        name: Import GPG key
        uses: crazy-max/ghaction-import-gpg@v6
        id: import_gpg
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}
          passphrase: ${{ secrets.PASSPHRASE }}
      -
        name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: '~> v2'
          args: release --clean
        env:
          GPG_FINGERPRINT: ${{ steps.import_gpg.outputs.fingerprint }}
          # GitHub sets this automatically
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  generate-changelog:
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.DOCUSAURUS_PAT }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      GITHUB_REPOSITORY: ${{ github.repository }}
    outputs:
      version: ${{ steps.generate.outputs.version }}
      versions_count: ${{ steps.generate.outputs.versions_count }}
      pr_list_file: ${{ steps.generate.outputs.pr_list_file }}
    steps:
      - name: Checkout terraform-provider-formal
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate GitHub App token
        uses: tibdex/github-app-token@v2
        id: generate-token
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.APP_PRIVATE_KEY }}
          repositories: '["terraform-provider-formal", "mintlify-docs"]'

      - name: Checkout mintlify-docs repo
        uses: actions/checkout@v5
        with:
          repository: formalco/mintlify-docs
          ref: main
          token: ${{ steps.generate-token.outputs.token }}
          path: docs-repo
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '18'

      - name: Generate changelog
        id: generate
        run: |
          echo "Generating changelog for Terraform Provider..."
          node .github/workflows/scripts/generate-changelog.js \
            --docs-repo-path docs-repo

      - name: Check for changes in docs repo
        id: check-changes
        working-directory: docs-repo
        run: |
          if git diff --quiet && git diff --cached --quiet && [ -z "$(git ls-files --others --exclude-standard)" ]; then
            echo "No changes detected"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "Changes detected:"
            git status --short
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create or update PR in mintlify-docs
        if: steps.check-changes.outputs.has_changes == 'true'
        working-directory: docs-repo
        env:
          GH_TOKEN: ${{ steps.generate-token.outputs.token }}
        run: |
          VERSION_RANGE="${{ steps.generate.outputs.version }}"
          VERSIONS_COUNT="${{ steps.generate.outputs.versions_count }}"
          PR_LIST_FILE="${{ steps.generate.outputs.pr_list_file }}"

          # Use fallback values if outputs are empty
          if [ -z "$VERSION_RANGE" ]; then
            VERSION_RANGE="latest"
          fi
          if [ -z "$VERSIONS_COUNT" ]; then
            VERSIONS_COUNT="1"
          fi

          # Read PR list if available
          PR_LIST=""
          if [ -n "$PR_LIST_FILE" ] && [ -f "$PR_LIST_FILE" ]; then
            PR_LIST=$(cat "$PR_LIST_FILE")
          fi

          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Check for existing open PR
          ALL_OPEN_PRS=$(gh pr list --state open --json number,headRefName 2>/dev/null || echo "[]")
          EXISTING_PR=$(echo "$ALL_OPEN_PRS" | jq ".[] | select(.headRefName | startswith(\"changelog/terraform-provider-\")) | {number, headRefName}" | jq -s '.[0]')

          if [ -n "$EXISTING_PR" ] && [ "$EXISTING_PR" != "null" ]; then
            EXISTING_BRANCH=$(echo "$EXISTING_PR" | jq -r '.headRefName')
            PR_NUMBER=$(echo "$EXISTING_PR" | jq -r '.number')

            echo "Found existing PR #${PR_NUMBER} with branch ${EXISTING_BRANCH}"
            echo "Updating existing PR..."

            BRANCH="$EXISTING_BRANCH"
            git fetch origin "$BRANCH"
            git checkout "$BRANCH"
            git add .
            git commit --amend --no-edit -m "docs: update Terraform Provider changelog (${VERSIONS_COUNT} versions)"
            git push origin "$BRANCH" --force

            if [ "$VERSIONS_COUNT" = "1" ]; then
              TITLE="docs: update Terraform Provider changelog ${VERSION_RANGE}"
              BODY="This PR updates the Terraform Provider changelog for version **${VERSION_RANGE}**."
            else
              TITLE="docs: update Terraform Provider changelog ${VERSION_RANGE}"
              BODY="This PR updates the Terraform Provider changelog with **${VERSIONS_COUNT} versions** (${VERSION_RANGE})."
            fi

            gh pr edit "$PR_NUMBER" \
              --title "$TITLE" \
              --body "$BODY

          Last updated: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Pull Requests Included
          ${PR_LIST}

          ## Next Steps
          1. Review the generated changelogs
          2. Edit if needed
          3. Merge to publish

          ğŸ¤– Generated with automation"

            echo "âœ… Updated PR #${PR_NUMBER}"
          else
            echo "Creating new PR..."

            TIMESTAMP=$(date +%Y%m%d-%H%M%S)
            BRANCH="changelog/terraform-provider-${TIMESTAMP}"
            git checkout -b "$BRANCH"
            git add .
            git commit -m "docs: update Terraform Provider changelog (${VERSIONS_COUNT} versions)"
            git push origin "$BRANCH"

            if [ "$VERSIONS_COUNT" = "1" ]; then
              TITLE="docs: update Terraform Provider changelog ${VERSION_RANGE}"
              BODY="This PR updates the Terraform Provider changelog for version **${VERSION_RANGE}**."
            else
              TITLE="docs: update Terraform Provider changelog ${VERSION_RANGE}"
              BODY="This PR updates the Terraform Provider changelog with **${VERSIONS_COUNT} versions** (${VERSION_RANGE})."
            fi

            PR_URL=$(gh pr create \
              --title "$TITLE" \
              --body "$BODY

          Generated from: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

          ## Pull Requests Included
          ${PR_LIST}

          ## Next Steps
          1. Review the generated changelogs
          2. Edit if needed
          3. Merge to publish

          ğŸ¤– Generated with automation" \
              --base main \
              --head "$BRANCH")

            PR_NUMBER=$(echo "$PR_URL" | grep -oE '[0-9]+$')
            echo "âœ… Created PR #${PR_NUMBER}"
          fi

      - name: Summary
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Terraform Provider changelog updated"
          echo "   Versions: ${{ steps.generate.outputs.version }}"
          echo "   Count: ${{ steps.generate.outputs.versions_count }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: No changes needed
        if: steps.check-changes.outputs.has_changes == 'false'
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "â„¹ï¸  No changelog updates needed"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"